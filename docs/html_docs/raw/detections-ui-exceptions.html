<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Rule exceptions and value lists | Elastic Security Solution | Elastic</title>
<link rel="home" href="index.html" title="Elastic Security Solution"/>
<link rel="up" href="detection-engine-overview.html" title="Detections and Alerts (beta)"/>
<link rel="prev" href="alerts-ui-monitor.html" title="Monitoring and troubleshooting rule executions"/>
<link rel="next" href="building-block-rule.html" title="About building-block rules"/>
<meta name="DC.type" content="Learn/Docs/"/>
<meta name="DC.subject" content=""/>
<meta name="DC.identifier" content=""/>
</head>
<body>
<div id="content">
<div class="breadcrumbs">
<span class="breadcrumb-link"><a href="index.html">Elastic Security Solution</a></span>
»
<span class="breadcrumb-link"><a href="detection-engine-overview.html">Detections and Alerts (beta)</a></span>
»
<span class="breadcrumb-node">Rule exceptions and value lists</span>
</div>
<div class="navheader">
<span class="prev">
<a href="alerts-ui-monitor.html">« Monitoring and troubleshooting rule executions</a>
</span>
<span class="next">
<a href="building-block-rule.html">About building-block rules »</a>
</span>
</div>
<div class="chapter xpack">
<div class="titlepage"><div><div>
<h2 class="title"><a id="detections-ui-exceptions"></a>Rule exceptions and value lists<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/7.9/docs/detections/detections-ui-exceptions.asciidoc">edit</a><a class="xpack_tag" href="/subscriptions"></a></h2>
</div></div></div>
<p>To prevent the creation of unwanted alerts, you can add exceptions to detection
rules. Exceptions contain the source event conditions that determine when
alerts are not generated. They provide a convenient way of allowing trusted
processes and network activity to function without producing unnecessary noise.</p>
<p>You can add multiple exceptions to one rule.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you add an exception to the
<a class="xref" href="detections-ui-exceptions.html#endpoint-rule-exceptions" title="Add Elastic Endpoint Security exceptions">Elastic Endpoint Security</a> rule, you can select to
add the exception to the Endpoint. When selected, the exception is added to
both the detection rule <span class="strong strong"><strong>and</strong></span> the Elastic Endpoint agent on your hosts.</p>
</div>
</div>
<p>In addition to defining exception queries for source event values, rule
exceptions can be used with value lists. Value lists are lists of items with
the same Elasticsearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.9/mapping-types.html" class="ulink" target="_top">data type</a>. You can create value lists
with these types:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">keyword</code> (many <a href="https://www.elastic.co/guide/en/ecs/1.5/ecs-field-reference.html" class="ulink" target="_top">ECS fields</a> are keywords)
</li>
<li class="listitem">
<code class="literal">ip</code>
</li>
<li class="listitem">
<code class="literal">ip_range</code>
</li>
<li class="listitem">
<code class="literal">text</code>
</li>
</ul>
</div>
<p>After creating value lists, you can use <code class="literal">is in list</code> and <code class="literal">is not in list</code>
operators to define exceptions.</p>
<h3><a id="_manage_value_lists"></a>Manage value lists<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/7.9/docs/detections/detections-ui-exceptions.asciidoc">edit</a></h3>
<p>To create a value list for use with exceptions:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>Prepare a <code class="literal">txt</code> or <code class="literal">csv</code> file with all the values you want to use for
determining exceptions from a single list. If you use a <code class="literal">txt</code> file, newlines
act as value delimiters.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>All values in the file must be of the same Elasticsearch type.</p>
</div>
</div>
</li>
<li class="listitem">
Go to <span class="strong strong"><strong>Security</strong></span> &#8594; <span class="strong strong"><strong>Detections</strong></span> &#8594; <span class="strong strong"><strong>Manage detection rules</strong></span>.
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Upload value lists</strong></span>.</p>
<p>The <span class="strong strong"><strong>Upload value lists</strong></span> window opens.</p>
</li>
</ol>
</div>
<div class="imageblock screenshot">
<div class="content">
<img src="images/upload-lists-ui.png" alt="upload lists ui">
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Select the list type (<code class="literal">Keywords</code>, <code class="literal">IP addresses</code>, <code class="literal">IP ranges</code>, or
<code class="literal">Text</code>)
</li>
<li class="listitem">
Drag or select the <code class="literal">csv</code> or <code class="literal">txt</code> file that contains the values.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Upload list</strong></span>.
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When the name of the file you are uploading already exists, the values in
the new file are appended to the previously uploaded values.</p>
</div>
</div>
<p>To view, delete, or export existing lists:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to <span class="strong strong"><strong>Security</strong></span> &#8594; <span class="strong strong"><strong>Detections</strong></span> &#8594; <span class="strong strong"><strong>Manage detection rules</strong></span>.
</li>
<li class="listitem">
In the <span class="strong strong"><strong>Value lists</strong></span> pane, click the required action icon.
</li>
</ol>
</div>
<h3><a id="detection-rule-exceptions"></a>Add detection exceptions to a rule<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/7.9/docs/detections/detections-ui-exceptions.asciidoc">edit</a></h3>
<p>You can add exceptions to a rule via the Rule details page or the Alerts table.
When you add an exception, you can also close all alerts that meet the
exception&#8217;s criteria.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>When you select to close all alerts that meet the exception&#8217;s
criteria, all matching alerts are closed, <span class="strong strong"><strong>including</strong></span> alerts generated by other
rules.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>To add an exception via the Rule details page:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to the Rule details page of the rule to which you want to add the
exception (<span class="strong strong"><strong>Security</strong></span> &#8594; <span class="strong strong"><strong>Detections</strong></span> &#8594; <span class="strong strong"><strong>Manage detection rules</strong></span> &#8594;
&lt;rule name&gt;).
</li>
<li class="listitem">
Scroll down to the <span class="strong strong"><strong>Trend</strong></span> histogram and select the <span class="strong strong"><strong>Exceptions</strong></span> tab.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add new exception</strong></span>.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>To add an exception via the Alerts table:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to Detections (<span class="strong strong"><strong>Security</strong></span> &#8594; <span class="strong strong"><strong>Detections</strong></span>).
</li>
<li class="listitem">
<p>Scroll down to the Alerts table and click the more actions icon, and then
select <span class="strong strong"><strong>Add exception</strong></span>.</p>
<p>The <span class="strong strong"><strong>Add Exception</strong></span> window opens (via Alerts table).</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/add-exception-ui.png" alt="add exception ui">
</div>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>Add conditions that define when the exception prevents alerts. You can define
multiple conditions with <code class="literal">OR</code> and <code class="literal">AND</code> relationships. In the example above,
the exception prevents the rule from generating alerts when the
<code class="literal">maintenance.exe</code> process runs on <code class="literal">win-server-1</code>, <code class="literal">win-server-2</code>, or
<code class="literal">win-server-3</code>.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>You can use nested conditions. However, this is only required for
<a class="xref" href="detections-ui-exceptions.html#nested-field-list">these fields</a>. For all other fields, nested conditions
should not be used.</p>
</div>
</div>
<p>If you have created value lists, you can use them to exclude or include all
values in a list with <code class="literal">is in list</code> and <code class="literal">is not in list</code> operators:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/exceptions-ui-list.png" alt="exceptions ui list">
</div>
</div>
</li>
</ol>
</div>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p>When using a list, all exception statements must use <code class="literal">is in list</code> and
<code class="literal">is not in list</code> operators.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>You can select any of the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<em>Close this alert</em>: Closes the alert when the exception is added. This option
is only available when adding exceptions via the Alerts table.
</li>
<li class="listitem">
<em>Close all alerts that match this exception, including alerts generated by other rules</em>:
Closes all alerts that match the exception&#8217;s conditions.
</li>
</ul>
</div>
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add Exception</strong></span>.
</li>
</ol>
</div>
<h3><a id="endpoint-rule-exceptions"></a>Add Elastic Endpoint Security exceptions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/7.9/docs/detections/detections-ui-exceptions.asciidoc">edit</a></h3>
<p>Like detection rule exceptions, you can add Endpoint agent exceptions via both
the Elastic Endpoint Security rule and its generated alerts. Alerts generated
from the Elastic Endpoint Security rule have the following fields:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">signal.original_event.module determined:endpoint</code>
</li>
<li class="listitem">
<code class="literal">signal.original_event.kind:alert</code>
</li>
</ul>
</div>
<p>Additionally, you can add Endpoint exceptions via rules that are associated
with Elastic endpoint rule exceptions. To associate rules, when creating or
editing a rule select the
<a class="xref" href="rules-ui-create.html#rule-ui-advanced-params" title="Configure advanced rule settings (optional)"><em>Elastic endpoint exceptions</em></a> option.</p>
<div class="important admon">
<div class="icon"></div>
<div class="admon_content">
<p>Exceptions added to the Elastic Endpoint Security rule affect all alerts sent
from the Endpoint agent. Be careful not to unintentionally prevent some Endpoint
alerts.</p>
</div>
</div>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
<p>To add an Endpoint exception via the Rule details page:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to the Rule details page and select the Elastic Security Endpoint rule
(<span class="strong strong"><strong>Security</strong></span> &#8594; <span class="strong strong"><strong>Detections</strong></span> &#8594; <span class="strong strong"><strong>Manage detection rules</strong></span> &#8594;
<span class="strong strong"><strong>Elastic Endpoint Security</strong></span>).
</li>
<li class="listitem">
Scroll down to the <span class="strong strong"><strong>Trend</strong></span> histogram and select the <span class="strong strong"><strong>Exceptions</strong></span> tab.
</li>
<li class="listitem">
Click <span class="strong strong"><strong>Add Endpoint exception</strong></span>.
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>To add an exception via the Alerts table:</p>
<div class="olist orderedlist">
<ol class="orderedlist">
<li class="listitem">
Go to Detections (<span class="strong strong"><strong>Security</strong></span> &#8594; <span class="strong strong"><strong>Detections</strong></span>).
</li>
<li class="listitem">
<p>Scroll down to the Alerts table and, from an Elastic Security Endpoint
alert, click the more actions icon, and then select <span class="strong strong"><strong>Add Endpoint exception</strong></span>.</p>
<p>The <span class="strong strong"><strong>Add Endpoint Exception</strong></span> window opens (via Alerts table).</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/endpoint-add-exp.png" alt="endpoint add exp">
</div>
</div>
</li>
</ol>
</div>
</li>
<li class="listitem">
<p>If required, modify the conditions.</p>
<div class="note admon">
<div class="icon"></div>
<div class="admon_content">
<p><a class="xref" href="detections-ui-exceptions.html#ex-nested-conditions" title="Exceptions with nested conditions">Exceptions with nested conditions</a> describes when nested conditions are required.</p>
</div>
</div>
</li>
<li class="listitem">
<p>You can select any of the following:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<em>Close this alert</em>: Closes the alert when the exception is added. This option
is only available when adding exceptions via the Alerts table.
</li>
<li class="listitem">
<em>Close all alerts that match this exception, including alerts generated by other rules</em>:
Closes all alerts that match the exception&#8217;s conditions.
</li>
</ul>
</div>
</li>
<li class="listitem">
<p>Click <span class="strong strong"><strong>Add Exception</strong></span>.</p>
<p>An exception is created for both the detection rule <span class="strong strong"><strong>and</strong></span> the Elastic Endpoint
agent.</p>
</li>
</ol>
</div>
<h3><a id="ex-nested-conditions"></a>Exceptions with nested conditions<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/7.9/docs/detections/detections-ui-exceptions.asciidoc">edit</a></h3>
<p>Some Endpoint objects contain nested fields, and the only way to ensure you are
excluding the correct fields is with nested conditions. One example is the
<code class="literal">process.Ext</code> object:</p>
<div class="pre_wrapper lang-json">
<pre class="programlisting prettyprint lang-json">{
  "ancestry": [],
  "code_signature": {
    "trusted": true,
    "subject_name": "LFC",
    "exists": true,
    "status": "trusted"
  },
  "user": "WDAGUtilityAccount",
  "token": {
    "elevation": true,
    "integrity_level_name": "high",
    "domain": "27FB305D-3838-4",
    "user": "WDAGUtilityAccount",
    "elevation_type": "default",
    "sid": "S-1-5-21-2047949552-857980807-821054962-504"
  }
}</pre>
</div>
<div class="tip admon">
<div class="icon"></div>
<div class="admon_content">
<p><code class="literal">code_signature.subject_name</code> refers to the process signature not the
process name.</p>
</div>
</div>
<p><a id="nested-field-list"></a>Only these objects require nested conditions to ensure the exception functions
correctly:</p>
<div class="ulist itemizedlist">
<ul class="itemizedlist">
<li class="listitem">
<code class="literal">Endpoint.policy.applied.artifacts.global.identifiers</code>
</li>
<li class="listitem">
<code class="literal">Endpoint.policy.applied.artifacts.user.identifiers</code>
</li>
<li class="listitem">
<code class="literal">Target.dll.Ext.code_signature</code>
</li>
<li class="listitem">
<code class="literal">Target.process.Ext.code_signature</code>
</li>
<li class="listitem">
<code class="literal">Target.process.Ext.token.privileges</code>
</li>
<li class="listitem">
<code class="literal">Target.process.parent.Ext.code_signature</code>
</li>
<li class="listitem">
<code class="literal">Target.process.thread.Ext.token.privileges</code>
</li>
<li class="listitem">
<code class="literal">dll.Ext.code_signature</code>
</li>
<li class="listitem">
<code class="literal">file.Ext.code_signature</code>
</li>
<li class="listitem">
<code class="literal">file.Ext.macro.errors</code>
</li>
<li class="listitem">
<code class="literal">file.Ext.macro.stream</code>
</li>
<li class="listitem">
<code class="literal">process.Ext.code_signature</code>
</li>
<li class="listitem">
<code class="literal">process.Ext.token.privileges</code>
</li>
<li class="listitem">
<code class="literal">process.parent.Ext.code_signature</code>
</li>
<li class="listitem">
<code class="literal">process.thread.Ext.token.privileges</code>
</li>
</ul>
</div>
<h4><a id="_nested_condition_example"></a>Nested condition example<a class="edit_me" rel="nofollow" title="Edit this page on GitHub" href="https://github.com/elastic/security-docs/edit/7.9/docs/detections/detections-ui-exceptions.asciidoc">edit</a></h4>
<p>Creates an exception that excludes all LFC-signed trusted processes:</p>
<div class="imageblock screenshot">
<div class="content">
<img src="images/nested-exp.png" alt="nested exp">
</div>
</div>
</div>
<div class="navfooter">
<span class="prev">
<a href="alerts-ui-monitor.html">« Monitoring and troubleshooting rule executions</a>
</span>
<span class="next">
<a href="building-block-rule.html">About building-block rules »</a>
</span>
</div>
</div>
</body>
</html>
