[[sip-provider-modification]]
=== SIP Provider Modification

Identifies modifications to the registered Subject Interface Package (SIP) providers. SIP providers are used by the Windows cryptographic system to validate file signatures on the system. This may be an attempt to bypass signature validation checks or inject code into critical processes.

*Rule type*: eql

<<<<<<< HEAD
*Rule indices*: 

* logs-endpoint.events.registry-*
* endgame-*
* logs-windows.sysmon_operational-*
* winlogbeat-*
* logs-m365_defender.event-*
* logs-sentinel_one_cloud_funnel.*
=======
*Rule indices*:

* logs-endpoint.events.*
* endgame-*
>>>>>>> 7c79a644 (8.17.0 Release notes  (#6224))

*Severity*: medium

*Risk score*: 47

<<<<<<< HEAD
*Runs every*: 5m
=======
*Runs every*: 5 minutes
>>>>>>> 7c79a644 (8.17.0 Release notes  (#6224))

*Searches indices from*: now-9m ({ref}/common-options.html#date-math[Date Math format], see also <<rule-schedule, `Additional look-back time`>>)

*Maximum alerts per execution*: 100

<<<<<<< HEAD
*References*: 

* https://github.com/mattifestation/PoCSubjectInterfacePackage

*Tags*: 

* Domain: Endpoint
* OS: Windows
* Use Case: Threat Detection
* Tactic: Defense Evasion
* Data Source: Elastic Endgame
* Data Source: Elastic Defend
* Data Source: Sysmon
* Data Source: Microsoft Defender for Endpoint
* Data Source: SentinelOne

*Version*: 310

*Rule authors*: 

* Elastic

*Rule license*: Elastic License v2


==== Rule query


[source, js]
----------------------------------
registry where host.os.type == "windows" and event.type == "change" and registry.value : ("Dll", "$Dll") and
  registry.path: (
    "*\\SOFTWARE\\Microsoft\\Cryptography\\OID\\EncodingType 0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll",
    "*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID\\EncodingType 0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll",
    "*\\SOFTWARE\\Microsoft\\Cryptography\\Providers\\Trust\\FinalPolicy\\{*}\\$Dll",
    "*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\Trust\\FinalPolicy\\{*}\\$Dll"
    ) and
  registry.data.strings:"*.dll" and
  not (process.name : "msiexec.exe" and registry.data.strings : "mso.dll") and
  not (process.name : "regsvr32.exe" and registry.data.strings == "WINTRUST.DLL")

----------------------------------
=======
*References*:

* https://github.com/mattifestation/PoCSubjectInterfacePackage

*Tags*:

* Elastic
* Host
* Windows
* Threat Detection
* Defense Evasion
* Elastic Endgame

*Version*: 101 (<<sip-provider-modification-history, version history>>)

*Added ({stack} release)*: 7.12.0

*Last modified ({stack} release)*: 8.6.0

*Rule authors*: Elastic

*Rule license*: Elastic License v2

==== Rule query


[source,js]
----------------------------------
registry where event.type:"change" and registry.path: (
"*\\SOFTWARE\\Microsoft\\Cryptography\\OID\\EncodingType
0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll",
"*\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\OID\\EncodingType
0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll", "*\\SOFTWARE\\Microsoft
\\Cryptography\\Providers\\Trust\\FinalPolicy\\{*}\\$Dll", "*\\SOF
TWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\Trust\\FinalPo
licy\\{*}\\$Dll" ) and registry.data.strings:"*.dll"
----------------------------------

==== Threat mapping
>>>>>>> 7c79a644 (8.17.0 Release notes  (#6224))

*Framework*: MITRE ATT&CK^TM^

* Tactic:
** Name: Defense Evasion
** ID: TA0005
** Reference URL: https://attack.mitre.org/tactics/TA0005/
* Technique:
** Name: Subvert Trust Controls
** ID: T1553
** Reference URL: https://attack.mitre.org/techniques/T1553/
<<<<<<< HEAD
* Sub-technique:
** Name: SIP and Trust Provider Hijacking
** ID: T1553.003
** Reference URL: https://attack.mitre.org/techniques/T1553/003/
=======

[[sip-provider-modification-history]]
==== Rule version history

Version 101 (8.6.0 release)::
* Updated query, changed from:
+
[source, js]
----------------------------------
registry where event.type:"change" and registry.path: (
"HKLM\\SOFTWARE\\Microsoft\\Cryptography\\OID\\EncodingType
0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll", "HKLM\\SOFTWARE\\WOW643
2Node\\Microsoft\\Cryptography\\OID\\EncodingType
0\\CryptSIPDllPutSignedDataMsg\\{*}\\Dll", "HKLM\\SOFTWARE\\Micros
oft\\Cryptography\\Providers\\Trust\\FinalPolicy\\{*}\\$Dll", "HKL
M\\SOFTWARE\\WOW6432Node\\Microsoft\\Cryptography\\Providers\\Trust\\F
inalPolicy\\{*}\\$Dll" ) and registry.data.strings:"*.dll"
----------------------------------

Version 100 (8.5.0 release)::
* Formatting only

Version 3 (8.4.0 release)::
* Formatting only

Version 2 (8.1.0 release)::
* Formatting only

>>>>>>> 7c79a644 (8.17.0 Release notes  (#6224))
