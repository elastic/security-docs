[[google-workspace-mfa-enforcement-disabled]]
=== Google Workspace MFA Enforcement Disabled

Detects when multi-factor authentication (MFA) enforcement is disabled for Google Workspace users. An adversary may disable MFA enforcement in order to weaken an organizationâ€™s security controls.

*Rule type*: query

*Rule indices*:

* filebeat-*
* logs-google_workspace*

*Severity*: medium

*Risk score*: 47

*Runs every*: 10 minutes

*Searches indices from*: now-130m ({ref}/common-options.html#date-math[Date Math format], see also <<rule-schedule, `Additional look-back time`>>)

*Maximum alerts per execution*: 100

*References*:

* https://support.google.com/a/answer/9176657?hl=en#

*Tags*:

* Elastic
* Cloud
* Google Workspace
* Continuous Monitoring
* SecOps
* Configuration Audit
* Impact
* has_guide

*Version*: 102 (<<google-workspace-mfa-enforcement-disabled-history, version history>>)

*Added ({stack} release)*: 7.11.0

*Last modified ({stack} release)*: 8.6.0

*Rule authors*: Elastic

*Rule license*: Elastic License v2

==== Potential false positives

MFA policies may be modified by system administrators. Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior.

==== Investigation guide


[source,markdown]
----------------------------------
## Triage and analysis

### Investigating Google Workspace MFA Enforcement Disabled

Multi-factor authentication is a process in which users are prompted during the sign-in process for an additional form
of identification, such as a code on their cellphone or a fingerprint scan.

If you only use a password to authenticate a user, it leaves an insecure vector for attack. If the password is weak or
has been exposed elsewhere, an attacker could be using it to gain access. When you require a second form of authentication,
security is increased because this additional factor isn't something that's easy for an attacker to obtain or duplicate.

For more information about using MFA in Google Workspace, access the [official documentation](https://support.google.com/a/answer/175197).

This rule identifies the disabling of MFA enforcement in Google Workspace. This modification weakens the security of
the accounts and can lead to the compromise of accounts and other assets.

#### Possible investigation steps

- Identify the user account that performed the action and whether it should perform this kind of action.
- Investigate other alerts associated with the user account during the past 48 hours.
- Contact the account and resource owners and confirm whether they are aware of this activity.
- Check if this operation was approved and performed according to the organization's change management policy.
- If you suspect the account has been compromised, scope potentially compromised assets by tracking servers, services,
and data accessed by the account in the last 24 hours.

### False positive analysis

- While this activity can be done by administrators, all users must use MFA. The security team should address any
potential benign true positive (B-TP), as this configuration can risk the user and domain.

### Response and remediation

- Initiate the incident response process based on the outcome of the triage.
- Disable or limit the account during the investigation and response.
- Identify the possible impact of the incident and prioritize accordingly; the following actions can help you gain context:
    - Identify the account role in the cloud environment.
    - Assess the criticality of affected services and servers.
    - Work with your IT team to identify and minimize the impact on users.
    - Identify if the attacker is moving laterally and compromising other accounts, servers, or services.
    - Identify any regulatory or legal ramifications related to this activity.
- Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are
identified. Reset passwords or delete API keys as needed to revoke the attacker's access to the environment. Work with
your IT teams to minimize the impact on business operations during these actions.
- Reactivate the multi-factor authentication enforcement.
- Review the permissions assigned to the implicated user to ensure that the least privilege principle is being followed.
- Implement security best practices [outlined](https://support.google.com/a/answer/7587183) by Google.
- Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector.
- Using the incident response data, update logging and audit policies to improve the mean time to detect (MTTD) and the
mean time to respond (MTTR).



### Important Information Regarding Google Workspace Event Lag Times
- As per Google's documentation, Google Workspace administrators may observe lag times ranging from minutes up to 3 days between the time of an event's occurrence and the event being visible in the Google Workspace admin/audit logs.
- This rule is configured to run every 10 minutes with a lookback time of 130 minutes.
- To reduce the risk of false negatives, consider reducing the interval that the Google Workspace (formerly G Suite) Filebeat module polls Google's reporting API for new events.
- By default, `var.interval` is set to 2 hours (2h). Consider changing this interval to a lower value, such as 10 minutes (10m).
- See the following references for further information:
  - https://support.google.com/a/answer/7061566
  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-google_workspace.html
----------------------------------


==== Rule query


[source,js]
----------------------------------
event.dataset:google_workspace.admin and event.provider:admin and
event.category:iam and event.action:ENFORCE_STRONG_AUTHENTICATION
and google_workspace.admin.new_value:false
----------------------------------

==== Threat mapping

*Framework*: MITRE ATT&CK^TM^

* Tactic:
** Name: Impact
** ID: TA0040
** Reference URL: https://attack.mitre.org/tactics/TA0040/
* Technique:
** Name: Account Access Removal
** ID: T1531
** Reference URL: https://attack.mitre.org/techniques/T1531/

[[google-workspace-mfa-enforcement-disabled-history]]
==== Rule version history

Version 102 (8.6.0 release)::
* Formatting only

Version 101 (8.5.0 release)::
* Formatting only

Version 15 (8.4.0 release)::
* Updated query, changed from:
+
[source, js]
----------------------------------
event.dataset:google_workspace.admin and event.provider:admin and
event.category:iam and event.action:ENFORCE_STRONG_AUTHENTICATION and
google_workspace.admin.new_value:false
----------------------------------

Version 13 (8.3.0 release)::
* Formatting only

Version 11 (8.2.0 release)::
* Formatting only

Version 7 (8.0.0 release)::
* Updated query, changed from:
+
[source, js]
----------------------------------
event.dataset:(gsuite.admin or google_workspace.admin) and
event.provider:admin and event.category:iam and
event.action:ENFORCE_STRONG_AUTHENTICATION and
(gsuite.admin.new_value:false or
google_workspace.admin.new_value:false)
----------------------------------

Version 6 (7.15.0 release)::
* Formatting only

Version 5 (7.14.0 release)::
* Updated query, changed from:
+
[source, js]
----------------------------------
event.dataset:(gsuite.admin or google_workspace.admin) and
event.provider:admin and event.category:iam and
event.action:ENFORCE_STRONG_AUTHENTICATION and
gsuite.admin.new_value:false
----------------------------------

Version 4 (7.13.0 release)::
* Formatting only

Version 3 (7.12.0 release)::
* Formatting only

Version 2 (7.11.2 release)::
* Formatting only

