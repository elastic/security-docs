[[machine-learning-detected-a-dns-request-predicted-to-be-a-dga-domain]]
=== Machine Learning Detected a DNS Request Predicted to be a DGA Domain

A supervised machine learning model has identified a DNS question name that is predicted to be the result of a Domain Generation Algorithm (DGA), which could indicate command and control network activity.

*Rule type*: query

*Rule indices*: 

* logs-endpoint.events.*
* logs-network_traffic.*

*Severity*: low

*Risk score*: 21

*Runs every*: 5m

*Searches indices from*: now-10m ({ref}/common-options.html#date-math[Date Math format], see also <<rule-schedule, `Additional look-back time`>>)

*Maximum alerts per execution*: 100

*References*: 

* https://www.elastic.co/guide/en/security/current/prebuilt-ml-jobs.html
* https://docs.elastic.co/en/integrations/dga
* https://www.elastic.co/security-labs/detect-domain-generation-algorithm-activity-with-new-kibana-integration

*Tags*: 

* Domain: Network
* Domain: Endpoint
* Data Source: Elastic Defend
* Use Case: Domain Generation Algorithm Detection
* Rule Type: ML
* Rule Type: Machine Learning
* Tactic: Command and Control

*Version*: 2

*Rule authors*: 

* Elastic

*Rule license*: Elastic License v2


==== Setup


The rule requires the Domain Generation Algorithm (DGA) Detection integration assets to be installed, as well as DNS events collected by integrations such as Elastic Defend, Network Packet Capture, or Packetbeat.  


*DGA Detection Setup*

The DGA Detection integration consists of an ML-based framework to detect DGA activity in DNS events.


*Prerequisite Requirements:*

- Fleet is required for DGA Detection.
- To configure Fleet Server refer to the https://www.elastic.co/guide/en/fleet/current/fleet-server.html[documentation].
- DNS events collected by the https://docs.elastic.co/en/integrations/endpoint[Elastic Defend], https://docs.elastic.co/integrations/network_traffic[Network Packet Capture] integration, or https://www.elastic.co/guide/en/beats/packetbeat/current/packetbeat-overview.html[Packetbeat].
- To install Elastic Defend, refer to the https://www.elastic.co/guide/en/security/current/install-endpoint.html[documentation].
- To add the Network Packet Capture integration to an Elastic Agent policy, refer to https://www.elastic.co/guide/en/fleet/current/add-integration-to-policy.html[this] guide.
- To set up and run Packetbeat, follow https://www.elastic.co/guide/en/beats/packetbeat/current/setting-up-and-running.html[this] guide.


*The following steps should be executed to install assets associated with the DGA Detection integration:*

- Go to the Kibana homepage. Under Management, click Integrations.
- In the query bar, search for Domain Generation Algorithm Detection and select the integration to see more details about it.
- Under Settings, click Install Domain Generation Algorithm Detection assets and follow the prompts to install the assets.


*Ingest Pipeline Setup*

Before you can enable this rule, you'll need to enrich DNS events with predictions from the Supervised DGA Detection model. This is done via the ingest pipeline named `<package_version>-ml_dga_ingest_pipeline` installed with the DGA Detection package.
- If using an Elastic Beat such as Packetbeat, add the DGA ingest pipeline to it by adding a simple configuration https://www.elastic.co/guide/en/elasticsearch/reference/current/ingest.html#pipelines-for-beats[setting] to `packetbeat.yml`.
- If adding the DGA ingest pipeline to an existing pipeline, use a https://www.elastic.co/guide/en/elasticsearch/reference/current/pipeline-processor.html[pipeline processor].


*Adding Custom Mappings*

- Go to the Kibana homepage. Under Management, click Stack Management.
- Under Data click Index Management and navigate to the Component Templates tab.
- Templates that can be edited to add custom components will be marked with a @custom suffix. Edit the @custom component template corresponding to the beat/integration you added the DGA ingest pipeline to, by pasting the following JSON blob in the "Load JSON" flyout:
```
{
  "properties": {
    "ml_is_dga": {
      "properties": {
        "malicious_prediction": {
          "type": "long"
        },
        "malicious_probability": {
          "type": "float"
        }
      }
    }
  }
}
```


==== Rule query


[source, js]
----------------------------------
ml_is_dga.malicious_prediction:1 and not dns.question.registered_domain:avsvmcloud.com

----------------------------------

*Framework*: MITRE ATT&CK^TM^

* Tactic:
** Name: Command and Control
** ID: TA0011
** Reference URL: https://attack.mitre.org/tactics/TA0011/
* Technique:
** Name: Dynamic Resolution
** ID: T1568
** Reference URL: https://attack.mitre.org/techniques/T1568/
* Sub-technique:
** Name: Domain Generation Algorithms
** ID: T1568.002
** Reference URL: https://attack.mitre.org/techniques/T1568/002/
