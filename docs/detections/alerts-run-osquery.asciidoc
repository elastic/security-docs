[[alerts-run-osquery]]
== Run Osquery from a detection alert
{kibana-ref}/osquery.html[Osquery] allows you to run live queries against an alert's host to learn more about your infrastructure and operating systems. For example, with Osquery, you can search your system for indicators of compromise that might have contributed to the alert. You can then use this data to form your investigation and alert triage efforts.

IMPORTANT: You must have the Osquery manager integration installed and the appropriate privileges to use Osquery. Refer to <<osquery-prereqs>> for more information.

[float]
[[osquery-alert-action]]
=== Run live queries

. Do one of the following from the Alerts table:
** Click the *View details* button to open the Alert details flyout, then click *Take action -> Run Osquery*.
** Select the *More actions* menu (*...*), then select *Run Osquery*.
. Choose to run a single query or a query pack.
. Select one or more {agent}s or groups to query. Start typing in the search field to get suggestions for {agent}s by name, ID, platform, and policy.

+
NOTE: The host associated with the alert is automatically selected. You can specify additional hosts to query.

. Specify the query or pack to run:
** *Query*: Select a saved query or enter a new one in the text box. After you enter the query, you can expand the **Advanced** section to view or set {kibana-ref}/osquery.html#osquery-map-fields[mapped ECS fields] included in the results from the live query. Mapping ECS fields is optional.
** *Pack*: Select from query packs that have been loaded and activated. After you select a pack, all of the queries in the pack are displayed.
+
TIP: Refer to {kibana-ref}/osquery.html#osquery-prebuilt-packs-queries[prebuilt packs] to learn about using and managing Elastic prebuilt packs.
+
[role="screenshot"]
image::images/setup-query.png[width=80%][height=80%][Shows how to set up a single query]

. Click **Submit**. Queries will timeout after 5 minutes if there are no responses.
+
TIP: To save the query for future use, click *Save for later* and define the ID,
description, and other {kibana-ref}/osquery.html#osquery-manage-query[details].

[float]
[[osquery-results-single]]
=== Review single query results

Results for single queries appear in the *Results* tab. When you run a query, the number of agents queried and query status temporarily display in a status bar above the results table. Agent responses can be `Sucessful`, `Not yet responded` (pending), and `Failed`.

[role="screenshot"]
image::images/single-query-results.png[width=80%][height=80%][Shows query results]

[float]
[[osquery-results-pack]]
=== Review query pack results

Results for each query in the pack appear in the *Results* tab. Click the expand button (image:images/pack-expand-button-osquery.png[Click markdown icon,20,20]) at the far right of each query row to display query results. The number of agents that were queried and their responses are shown for each query. Agent responses are color-coded. Green is `Sucessful`, `Not yet responded` (pending) is gray, and `Failed` is red.

[role="screenshot"]
image::images/pack-query-results.png[width=80%][height=80%][Shows query results]

[float]
[[osquery-investigate]]
=== Investigate query results

From the results table, you can:

* Click the *View in Discover* button (image:images/discover-button-osquery.png[Click the View in Discover button,20,20])  to explore the results in Discover.
* Click the *View in Lens* button (image:images/lens-button-osquery.png[Click the View in Lens button,20,20]) to navigate to Lens, where you can use the drag-and-drop *Lens* editor to create visualizations.
* Click the *Timeline* button (image:images/timeline-button-osquery.png[Click Timeline button,20,20]) to investigate a single query result in Timeline or *Add to timeline investigation* to investigate all results. This option is only available for single query results.

+
When you open all results in Timeline, the events in Timeline are filtered based on the `action_ID` generated by the Osquery query.
+

* Click the *Add to Case* button (image:images/case-button-osquery.png[Click Add to Case button,20,20]) to add the query results to a new or existing case.
+
NOTE: If you add the results to a new case, you are prompted to specify the solution that you want the create the case within. Ensure you select the correct solution. From {elastic-sec}, you cannot access cases created in {observability} or Stack Management.

* View more information about the request, such as failures, by opening the *Status* tab.
